<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Calcul mental — Entraînement</title>
<style>
    body { font-family: Arial, sans-serif; margin: 40px; font-size: 18px; }
    h1 { color: #333; }
    #question { font-size: 2em; margin-top: 20px; }
    #result { margin-top: 30px; }
</style>
</head>
<body>

<h1>Entraînement — Calcul mental</h1>

<div id="setup">

    <p>Choisir les opérations :</p>

    <label><input type="checkbox" value="-9" checked> −9</label><br>
    <label><input type="checkbox" value="-8"> −8</label><br>
    <label><input type="checkbox" value="-19" checked> −19</label><br>
    <label><input type="checkbox" value="-18"> −18</label><br>
    <label><input type="checkbox" value="-29"> −29</label><br>
    <label><input type="checkbox" value="-28"> −28</label><br>
    <label><input type="checkbox" value="*4" checked> ×4</label><br>
    <label><input type="checkbox" value="*8"> ×8</label><br>

    <br>

    <label>Temps maximal (secondes) :</label>
    <input type="number" id="tempsMax" value="60"><br><br>

    <label>Nombre de calculs :</label>
    <input type="number" id="nbCalculs" value="15"><br><br>

    <button onclick="demarrer()">Démarrer</button>

</div>

<div id="jeu" style="display:none;">
    <div id="timer"></div>
    <div id="question"></div>
    <input type="number" id="reponse" autocomplete="off">
    <button onclick="valider()">Valider</button>
</div>

<div id="result"></div>

<script>
let exercices = [];
let index = 0;
let reponses = [];
let startTime = 0;
let tempsMax = 0;
let timerInterval = null;

// utilitaires
function randint(a, b) { // inclusif
    return Math.floor(Math.random() * (b - a + 1)) + a;
}
function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
}

// Génère un nombre "facile" : majorité 2 chiffres, parfois 3 chiffres bas
function nombreFacile() {
    const r = Math.random();
    if (r < 0.75) return randint(10, 199);   // très souvent 2 chiffres / petit 3 chiffres
    return randint(200, 499);                // un peu plus grand mais encore mental
}

// Génère un nombre "plus dur" : 3-4 chiffres raisonnables
function nombreDifficile() {
    const r = Math.random();
    if (r < 0.60) return randint(100, 999);  // beaucoup de 3 chiffres
    return randint(1000, 4000);              // quelques 4 chiffres, mais pas trop
}

function fabriquerExercice(n, op) {

    let question, correct;

    if (op.startsWith("-")) {
        const d = Math.abs(parseInt(op));   // valeur positive

        // Sécurité : éviter les résultats négatifs
        if (n < d) return null;

        question = `${n}-${d}`;
        correct = n - d;
    }

    else if (op.startsWith("*")) {
        const m = parseInt(op.substring(1));

        question = `${n} × ${m}`;
        correct = n * m;
    }

    return { question, correct, key: n + op };
}


function demarrer() {
    const ops = [...document.querySelectorAll("input[type=checkbox]:checked")]
                    .map(cb => cb.value);

    if (ops.length === 0) {
        alert("Choisir au moins une opération.");
        return;
    }

    const nb = parseInt(document.getElementById("nbCalculs").value);
    tempsMax = parseInt(document.getElementById("tempsMax").value);

    // Au moins la moitié facile
    const nbFaciles = Math.ceil(nb / 2);
    const nbDifficiles = nb - nbFaciles;

    const deja = new Set();
    const exos = [];

    function pushUnique(ex) {
        if (deja.has(ex.key)) return false;
        deja.add(ex.key);
        exos.push({ question: ex.question, correct: ex.correct });
        return true;
    }

    // 1) faciles
    while (exos.length < nbFaciles) {
        const op = ops[Math.floor(Math.random() * ops.length)];
        const n = nombreFacile();
        pushUnique(fabriquerExercice(n, op));
    }

    // 2) plus durs
    while (exos.length < nbFaciles + nbDifficiles) {
        const op = ops[Math.floor(Math.random() * ops.length)];
        const n = nombreDifficile();
        const ex = fabriquerExercice(n, op);
        if (ex !== null) pushUnique(ex);
    }

    // mélange final
    exercices = shuffle(exos);

    index = 0;
    reponses = [];

    document.getElementById("setup").style.display = "none";
    document.getElementById("jeu").style.display = "block";
    document.getElementById("result").innerHTML = "";

    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 200);

    afficher();

    // validation par Entrée (on évite d'ajouter plusieurs listeners si on relance)
    const input = document.getElementById("reponse");
    input.onkeydown = (e) => { if (e.key === "Enter") valider(); };
}

function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const remaining = tempsMax - elapsed;

    document.getElementById("timer").textContent =
        "Temps : " + elapsed + " s (reste " + (remaining > 0 ? remaining : 0) + " s)";

    if (remaining <= 0) {
        clearInterval(timerInterval);
        fin(true);
    }
}

function afficher() {
    document.getElementById("question").textContent =
        "Calculer " + exercices[index].question;

    const input = document.getElementById("reponse");
    input.value = "";
    input.focus();
}

function valider() {
    const r = parseInt(document.getElementById("reponse").value);
    reponses.push(isNaN(r) ? null : r);

    index++;

    if (index >= exercices.length) {
        clearInterval(timerInterval);
        const depasse = (Date.now() - startTime) / 1000 > tempsMax;
        fin(depasse);
    } else {
        afficher();
    }
}

function fin(depasse) {
    document.getElementById("jeu").style.display = "none";

    let html = "<h2>Correction</h2>";
    if (depasse) html += "<p style='color:red'>⏱ Temps dépassé</p>";

    html += "<ul>";

    exercices.forEach((ex, i) => {
        const rep = reponses[i];
        const ok = rep === ex.correct;

        html += `<li>${ex.question} = ${ex.correct} — Réponse : ${rep === null ? "?" : rep} ${ok ? "✔️" : "❌"}</li>`;
    });

    html += "</ul>";

    document.getElementById("result").innerHTML = html;
}
</script>

</body>
</html>
